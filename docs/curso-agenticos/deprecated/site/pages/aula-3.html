<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aula 3: Arquitetura de Agentes | Sistemas Agênticos</title>
    <link rel="stylesheet" href="../css/main.css">
</head>
<body>
    <!-- Header -->
    <header class="site-header">
        <div class="header-content">
            <a href="../index.html" class="logo">
                <span class="logo-icon">§</span>
                <span class="logo-text">Sistemas Agênticos</span>
            </a>

            <nav class="nav-main">
                <a href="../index.html" class="nav-link">Início</a>
                <div class="nav-dropdown">
                    <button class="nav-link dropdown-trigger">
                        Aulas
                        <svg class="dropdown-icon" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div class="dropdown-menu">
                        <a href="aula-0.html" class="dropdown-item">Aula 0: Abertura</a>
                        <a href="aula-1.html" class="dropdown-item">Aula 1: Sistema na Prática</a>
                        <a href="aula-2a.html" class="dropdown-item">Aula 2A: Anatomia</a>
                        <a href="aula-2b.html" class="dropdown-item">Aula 2B: Claude Code</a>
                        <a href="aula-3.html" class="dropdown-item active">Aula 3: Arquitetura</a>
                        <a href="aula-4.html" class="dropdown-item">Aula 4: Construindo</a>
                        <a href="aula-5.html" class="dropdown-item">Aula 5: Sistema Jurídico</a>
                    </div>
                </div>
                <a href="glossario.html" class="nav-link">Glossário</a>
                <a href="recursos.html" class="nav-link">Recursos</a>
            </nav>

            <div class="header-actions">
                <button class="theme-toggle" aria-label="Alternar tema">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <main>
        <!-- Lesson Hero -->
        <section class="lesson-hero">
            <div class="hero-content">
                <div class="lesson-badge">Módulo 3 - Arquitetura</div>
                <h1 class="hero-title">Arquitetura de Agentes</h1>
                <p class="hero-subtitle">
                    Dominar os padrões arquiteturais para construir sistemas agênticos robustos:
                    workflows, orquestração, pipelines, paralelização e gates.
                </p>
                <div class="hero-meta">
                    <span class="meta-item">
                        <svg viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                        </svg>
                        ~3h
                    </span>
                    <span class="meta-item">
                        <svg viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Conceitos Avançados
                    </span>
                    <span class="meta-item">
                        <svg viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3z" />
                        </svg>
                        7 Blocos
                    </span>
                </div>
            </div>
        </section>

        <!-- Lesson Content -->
        <div class="lesson-layout">
            <!-- Sidebar Navigation -->
            <aside class="lesson-sidebar">
                <nav class="lesson-nav">
                    <div class="nav-section">
                        <h4 class="nav-section-title">Nesta Aula</h4>
                        <a href="#bloco1" class="lesson-nav-link">1. Workflow vs Agent</a>
                        <a href="#bloco2" class="lesson-nav-link">2. Orquestração</a>
                        <a href="#bloco3" class="lesson-nav-link">3. Pipelines</a>
                        <a href="#bloco4" class="lesson-nav-link">4. Paralelização</a>
                        <a href="#bloco5" class="lesson-nav-link">5. Contexto</a>
                        <a href="#bloco6" class="lesson-nav-link">6. Gates</a>
                        <a href="#bloco7" class="lesson-nav-link">7. Síntese</a>
                    </div>
                </nav>
            </aside>

            <!-- Main Content -->
            <div class="lesson-content">
                <!-- Bloco 1: Workflow vs Agent -->
                <section id="bloco1" class="lesson-block">
                    <h2>Bloco 1: Workflow vs Agent</h2>
                    <span class="badge badge-time">30 min</span>

                    <h3>1.1 A Distinção Fundamental</h3>

                    <blockquote>
                        <p>"Para a maioria das aplicações, o sistema agêntico de produção será uma
                        combinação de workflows e agentes."</p>
                        <cite>— Anthropic Best Practices</cite>
                    </blockquote>

                    <pre class="diagram"><code>┌─────────────────────────────────────────────────────────────────────────┐
│                           WORKFLOW                                      │
│         Fluxo DETERMINÍSTICO com etapas PREDEFINIDAS                    │
│                                                                         │
│   ┌─────┐    ┌─────┐    ┌─────┐    ┌─────┐                              │
│   │ LLM │───►│ LLM │───►│ LLM │───►│ LLM │                              │
│   │  1  │    │  2  │    │  3  │    │  4  │                              │
│   └─────┘    └─────┘    └─────┘    └─────┘                              │
│      │          │          │          │                                 │
│   prompt     prompt     prompt     prompt                               │
│   fixo 1     fixo 2     fixo 3     fixo 4                               │
│                                                                         │
│   ► Cada etapa conhecida de antemão                                     │
│   ► Fluxo previsível e testável                                         │
│   ► Sem decisões autônomas sobre próximo passo                          │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                            AGENT                                        │
│         Loop AUTÔNOMO que decide próximas ações                         │
│                                                                         │
│                      ┌─────────────┐                                    │
│              ┌──────►│    MODEL    │◄──────┐                            │
│              │       │  (decide)   │       │                            │
│              │       └──────┬──────┘       │                            │
│              │              │              │                            │
│              │              ▼              │                            │
│         ┌────┴────┐   ┌─────────┐   ┌─────┴─────┐                       │
│         │ Tool A  │   │ Tool B  │   │  Tool C   │                       │
│         └─────────┘   └─────────┘   └───────────┘                       │
│                                                                         │
│   ► Modelo decide qual tool usar                                        │
│   ► Fluxo adaptativo e imprevisível                                     │
│   ► Autonomia para resolver problemas inesperados                       │
└─────────────────────────────────────────────────────────────────────────┘</code></pre>

                    <h3>1.2 Quando Usar Cada Um</h3>

                    <table class="table-styled">
                        <thead>
                            <tr>
                                <th>Critério</th>
                                <th>Workflow</th>
                                <th>Agent</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Tarefa</td>
                                <td>Repetitiva, previsível</td>
                                <td>Exploratória, ambígua</td>
                            </tr>
                            <tr>
                                <td>Determinismo</td>
                                <td>Crítico (auditoria)</td>
                                <td>Aceitável variabilidade</td>
                            </tr>
                            <tr>
                                <td>Custo</td>
                                <td>Otimizado (previsível)</td>
                                <td>Variável (exploração)</td>
                            </tr>
                            <tr>
                                <td>Observabilidade</td>
                                <td>Alta (rastreável)</td>
                                <td>Média (decisões internas)</td>
                            </tr>
                            <tr>
                                <td>Uso típico</td>
                                <td>Produção, escala</td>
                                <td>Exploração, uso pessoal</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3>1.3 Analogia Jurídica</h3>

                    <pre class="diagram"><code>WORKFLOW = Linha de produção de sentenças de BPC
├─ Etapa 1: Ler relatório (sempre igual)
├─ Etapa 2: Verificar requisitos (checklist fixo)
├─ Etapa 3: Aplicar precedente (Tema 1066)
├─ Etapa 4: Gerar dispositivo (template)
└─ Resultado: Sentença padronizada

AGENT = Juiz analisando caso complexo
├─ Decide: "Preciso de mais provas?"
├─ Decide: "Qual linha jurisprudencial seguir?"
├─ Decide: "Devo chamar perito?"
├─ Adapta: Muda estratégia conforme evidências
└─ Resultado: Sentença sob medida</code></pre>

                    <div class="callout callout-gold">
                        <div class="callout-title">Insight para Juristas</div>
                        <p>A maioria dos processos repetitivos (BPC, auxílio-doença padrão) é melhor resolvida com
                        <strong>workflows</strong>. Casos complexos (hard cases) exigem <strong>agentes</strong>.</p>
                    </div>

                    <h3>1.4 O Híbrido na Prática</h3>

                    <blockquote>
                        <p>"Most production agents weren't that agentic at all. They were mostly just software,
                        but there were these core things that a lot of people were doing."</p>
                        <cite>— Dex Horthy, AI Engineer</cite>
                    </blockquote>

                    <p><strong>Padrão emergente:</strong> Workflows com "bolsões agênticos"</p>

                    <pre class="diagram"><code>┌──────────────────────────────────────────────────────────────┐
│  WORKFLOW DETERMINÍSTICO                                     │
│                                                              │
│  ┌─────────┐     ┌─────────────────┐     ┌─────────┐        │
│  │ Etapa 1 │────►│ BOLSÃO AGÊNTICO │────►│ Etapa 3 │        │
│  │ (fixo)  │     │ (3-10 passos)   │     │ (fixo)  │        │
│  └─────────┘     │                 │     └─────────┘        │
│                  │ Agent decide:   │                        │
│                  │ - Qual tool?    │                        │
│                  │ - Quantas vezes?│                        │
│                  │ - Quando parar? │                        │
│                  └─────────────────┘                        │
└──────────────────────────────────────────────────────────────┘</code></pre>
                </section>

                <!-- Bloco 2: Orquestração -->
                <section id="bloco2" class="lesson-block">
                    <h2>Bloco 2: Padrões de Orquestração</h2>
                    <span class="badge badge-time">35 min</span>

                    <h3>2.1 O Que é um Orquestrador</h3>

                    <blockquote>
                        <p>"The core loop as the orchestrator... The subtasks are not determined by the user
                        but by the core loop, and the parallelism is decided on the fly."</p>
                        <cite>— Michele Catasta, Replit</cite>
                    </blockquote>

                    <p><strong>Orquestrador</strong> = Coordenador central que:</p>
                    <ul>
                        <li>Decide <strong>qual agente/tool</strong> executar</li>
                        <li>Determina <strong>ordem</strong> de execução</li>
                        <li>Gerencia <strong>estado</strong> entre etapas</li>
                        <li>Decide sobre <strong>paralelização</strong></li>
                    </ul>

                    <h3>2.2 Padrões de Routing</h3>

                    <h4>Padrão A: Rule-Based Routing</h4>

                    <pre class="diagram"><code>┌──────────────────────────────────────────────────────────────┐
│  ROUTER BASEADO EM REGRAS                                    │
│                                                              │
│  Input do Usuário                                            │
│       │                                                      │
│       ▼                                                      │
│  ┌───────────────────────────────────────────────────────┐   │
│  │  DECISION LOGIC (regras predefinidas)                 │   │
│  │                                                       │   │
│  │  if "clima" in query → Weather Agent                  │   │
│  │  if "jurídico" in query → Legal Agent                 │   │
│  │  else → General Agent                                 │   │
│  └───────────────────────────────────────────────────────┘   │
│       │                                                      │
│       ├────────────────┬────────────────┐                    │
│       ▼                ▼                ▼                    │
│  ┌─────────┐     ┌─────────┐     ┌─────────┐                 │
│  │ Weather │     │  Legal  │     │ General │                 │
│  │  Agent  │     │  Agent  │     │  Agent  │                 │
│  └─────────┘     └─────────┘     └─────────┘                 │
└──────────────────────────────────────────────────────────────┘

Vantagem: Previsível, testável, barato
Desvantagem: Rígido, não adapta a casos novos</code></pre>

                    <h4>Padrão B: LLM-Decided Routing</h4>

                    <pre class="diagram"><code>┌──────────────────────────────────────────────────────────────┐
│  ROUTER DECIDIDO POR LLM                                     │
│                                                              │
│  Input do Usuário                                            │
│       │                                                      │
│       ▼                                                      │
│  ┌───────────────────────────────────────────────────────┐   │
│  │  LLM CLASSIFIER                                       │   │
│  │                                                       │   │
│  │  "Analise esta query e decida:                        │   │
│  │   - Se é sobre clima → 'weather'                      │   │
│  │   - Se é sobre direito → 'legal'                      │   │
│  │   - Se é ambíguo → 'general'"                         │   │
│  └───────────────────────────────────────────────────────┘   │
│       │                                                      │
│       ▼                                                      │
│  Agente selecionado dinamicamente                            │
└──────────────────────────────────────────────────────────────┘

Vantagem: Flexível, adapta a novos casos
Desvantagem: Custo extra (uma chamada LLM), menos previsível</code></pre>

                    <h4>Padrão C: Supervised Routing (Human-in-the-Loop)</h4>

                    <pre class="diagram"><code>┌──────────────────────────────────────────────────────────────┐
│  ROUTER COM SUPERVISÃO HUMANA                                │
│                                                              │
│  Input do Usuário                                            │
│       │                                                      │
│       ▼                                                      │
│  ┌───────────────────────────────────────────────────────┐   │
│  │  LLM propõe rota                                      │   │
│  │  "Sugiro usar o Legal Agent porque..."                │   │
│  └───────────────────────────────────────────────────────┘   │
│       │                                                      │
│       ▼                                                      │
│  ┌───────────────────────────────────────────────────────┐   │
│  │  CHECKPOINT HUMANO                                    │   │
│  │  ✓ Aprovar    ✗ Rejeitar    ✎ Editar                 │   │
│  └───────────────────────────────────────────────────────┘   │
│       │                                                      │
│       ▼                                                      │
│  Agente aprovado executa                                     │
└──────────────────────────────────────────────────────────────┘

Uso: Decisões de alto risco, domínios críticos (jurídico, médico)</code></pre>

                    <h3>2.4 Exemplo: Orquestrador CLERK</h3>

                    <pre class="diagram"><code>┌─────────────────────────────────────────────────────────────────────────┐
│                    CLERK: ORQUESTRADOR JURÍDICO                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  MASTER ORCHESTRATOR (Claude Code)                                      │
│  ├─ Decisão: qual fase executar                                         │
│  ├─ Gestão de estado processual                                         │
│  └─ Escalação a juiz quando necessário                                  │
│                                                                         │
│  FASES (Workflows com bolsões agênticos):                               │
│  │                                                                      │
│  ├─ FASE 2: Relatório                                                   │
│  │  └─ Workflow: PDF → TXT → Refinamento Iterativo → Relatório.md      │
│  │                                                                      │
│  ├─ FASE 3: Pesquisa                                                    │
│  │  └─ BOLSÃO AGÊNTICO:                                                │
│  │     ├─ Agent decide: BNP primeiro? CJF? JULIA?                      │
│  │     ├─ Agent decide: quantas buscas?                                │
│  │     └─ Agent decide: quando parar?                                  │
│  │                                                                      │
│  ├─ FASE 4: Elaboração                                                  │
│  │  └─ Workflow: Relatório + Análise → Fundamentação → Dispositivo     │
│  │                                                                      │
│  └─ FASE 6: Revisão                                                     │
│     └─ PARALELO (Fan-out):                                              │
│        ├─ Subagente: Advogado do Diabo                                 │
│        ├─ Subagente: Consistência Interna                              │
│        ├─ Subagente: Consistência Externa                              │
│        └─ Consolidador (Fan-in)                                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘</code></pre>
                </section>

                <!-- Bloco 3: Pipelines -->
                <section id="bloco3" class="lesson-block">
                    <h2>Bloco 3: Pipelines e Encadeamento</h2>
                    <span class="badge badge-time">30 min</span>

                    <h3>3.1 O Que é um Pipeline</h3>

                    <p><strong>Definição:</strong> Sequência linear de transformações onde a saída de uma etapa
                    é entrada da próxima.</p>

                    <pre class="diagram"><code>┌──────────┐     ┌───────────┐     ┌──────────┐     ┌──────────┐
│  INPUT   │────►│  ETAPA 1  │────►│  ETAPA 2 │────►│  OUTPUT  │
│          │     │           │     │          │     │          │
└──────────┘     └───────────┘     └──────────┘     └──────────┘
                      │                 │
                 prompt fixo       prompt fixo</code></pre>

                    <h3>3.2 Padrão A: Linear Determinístico</h3>

                    <pre class="diagram"><code>PIPELINE JURÍDICO (CLERK):
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│Processo │───►│Relatório│───►│ Análise │───►│ Minuta  │
│  (PDF)  │    │  (.md)  │    │  (.md)  │    │  (.md)  │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
     │              │              │              │
  [entrada]   [transformação] [transformação] [saída]</code></pre>

                    <p><strong>Características:</strong></p>
                    <ul>
                        <li>Cada etapa tem prompt fixo</li>
                        <li>Output de N alimenta input de N+1</li>
                        <li>Determinístico (mesma entrada = mesmo resultado)</li>
                        <li>Ideal para tarefas repetitivas</li>
                    </ul>

                    <h3>3.2 Padrão B: Iterativo com Feedback</h3>

                    <blockquote>
                        <p>"The human instructions of why it failed... That text is really really valuable."</p>
                        <cite>— SallyAnn DeLucia, Arize</cite>
                    </blockquote>

                    <pre class="diagram"><code>┌──────────────────────────────────────────────────────────────┐
│  PIPELINE COM LOOP DE FEEDBACK                               │
│                                                              │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐                   │
│  │ Geração │───►│  Eval   │───►│ Feedback│                   │
│  └─────────┘    └────┬────┘    └────┬────┘                   │
│       ▲              │              │                        │
│       │              ▼              │                        │
│       │    ┌─────────────────┐      │                        │
│       │    │ Score < threshold│      │                        │
│       │    └────────┬────────┘      │                        │
│       │             │               │                        │
│       └─────────────┴───────────────┘                        │
│              (retry com feedback)                            │
└──────────────────────────────────────────────────────────────┘

Uso: Quando precisa melhorar qualidade iterativamente</code></pre>

                    <h3>3.3 RPI: Research-Plan-Implement</h3>

                    <p><strong>Padrão identificado em agentes de alta performance:</strong></p>

                    <pre class="diagram"><code>┌──────────────────────────────────────────────────────────────┐
│                    PADRÃO RPI                                │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ RESEARCH (Pesquisa)                                     │ │
│  │ ├─ Entender o problema                                  │ │
│  │ ├─ Explorar codebase / domínio                          │ │
│  │ └─ Gerar documento de descobertas                       │ │
│  └─────────────────────────────────────────────────────────┘ │
│                          │                                   │
│                    [CHECKPOINT HUMANO]                       │
│                "As descobertas estão corretas?"              │
│                          │                                   │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ PLAN (Planejamento)                                     │ │
│  │ ├─ Dividir em tarefas discretas                         │ │
│  │ ├─ Especificar arquivos, linhas, testes                 │ │
│  │ └─ Incluir estratégia de rollback                       │ │
│  └─────────────────────────────────────────────────────────┘ │
│                          │                                   │
│                    [CHECKPOINT HUMANO]                       │
│                 "O plano faz sentido?"                       │
│                          │                                   │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ IMPLEMENT (Implementação)                               │ │
│  │ ├─ Seguir plano passo a passo                           │ │
│  │ ├─ Rodar testes após cada mudança                       │ │
│  │ └─ Validar contra requisitos                            │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                              │
└──────────────────────────────────────────────────────────────┘

Analogia jurídica: Ler autos → Estruturar tese → Redigir sentença</code></pre>

                    <h3>3.4 Pipeline vs Agent: Matriz de Decisão</h3>

                    <table class="table-styled">
                        <thead>
                            <tr>
                                <th>Cenário</th>
                                <th>Melhor Abordagem</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Tarefas repetitivas com passos conhecidos</td><td><strong>Pipeline</strong></td></tr>
                            <tr><td>Resultado precisa ser auditável</td><td><strong>Pipeline</strong></td></tr>
                            <tr><td>Tarefas exploratórias</td><td><strong>Agent</strong></td></tr>
                            <tr><td>Precisa adaptar ao inesperado</td><td><strong>Agent</strong></td></tr>
                            <tr><td>Produção com escala</td><td><strong>Pipeline</strong></td></tr>
                            <tr><td>Uso pessoal/interativo</td><td><strong>Agent</strong></td></tr>
                            <tr><td>Tokens são críticos</td><td><strong>Pipeline</strong></td></tr>
                            <tr><td>Qualidade > Custo</td><td><strong>Agent</strong></td></tr>
                        </tbody>
                    </table>
                </section>

                <!-- Bloco 4: Paralelização -->
                <section id="bloco4" class="lesson-block">
                    <h2>Bloco 4: Paralelização e Fan-Out</h2>
                    <span class="badge badge-time">35 min</span>

                    <h3>4.1 Por Que Paralelizar</h3>

                    <blockquote>
                        <p>"If one agent gets stuck, all the other ones are still going to work.
                        Maybe we get to 90% or 95% solved."</p>
                        <cite>— Robert Brennan, AllHands</cite>
                    </blockquote>

                    <p><strong>Benefícios:</strong></p>
                    <ul>
                        <li><strong>Velocidade</strong> (tarefas simultâneas)</li>
                        <li><strong>Resiliência</strong> (falha parcial não para tudo)</li>
                        <li><strong>Eficiência</strong> (melhor uso de recursos)</li>
                    </ul>

                    <h3>4.2 Padrão Fan-Out / Fan-In</h3>

                    <pre class="diagram"><code>┌──────────────────────────────────────────────────────────────┐
│                    FAN-OUT / FAN-IN                          │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│                    ┌──────────┐                              │
│                    │  TAREFA  │                              │
│                    │ COMPLEXA │                              │
│                    └────┬─────┘                              │
│                         │                                    │
│            ┌────────────┼────────────┐                       │
│            │            │            │                       │
│            ▼            ▼            ▼                       │
│       ┌─────────┐  ┌─────────┐  ┌─────────┐                  │
│       │Subagent │  │Subagent │  │Subagent │   FAN-OUT        │
│       │    1    │  │    2    │  │    3    │   (divergência)  │
│       └────┬────┘  └────┬────┘  └────┬────┘                  │
│            │            │            │                       │
│            ▼            ▼            ▼                       │
│       ┌─────────┐  ┌─────────┐  ┌─────────┐                  │
│       │Result 1 │  │Result 2 │  │Result 3 │                  │
│       └────┬────┘  └────┬────┘  └────┬────┘                  │
│            │            │            │                       │
│            └────────────┼────────────┘                       │
│                         │                                    │
│                         ▼                                    │
│                  ┌─────────────┐                             │
│                  │ CONSOLIDADOR│   FAN-IN                    │
│                  │   (merge)   │   (convergência)            │
│                  └─────────────┘                             │
│                                                              │
└──────────────────────────────────────────────────────────────┘</code></pre>

                    <h3>4.3 Sub-Agents para Isolamento de Contexto</h3>

                    <blockquote>
                        <p>"Instead of filling up your context, you can delegate a researcher to go deep
                        into a specific problem to come back with the answer."</p>
                        <cite>— Jared Zoneraich, Claude Code</cite>
                    </blockquote>

                    <pre class="diagram"><code>┌──────────────────────────────────────────────────────────────┐
│  MAIN AGENT                                                  │
│  Context: 50K tokens usados                                  │
│                                                              │
│  Problema: Preciso entender arquivo de 10K tokens            │
│                                                              │
│  OPÇÃO A (ruim): Colocar arquivo no contexto                 │
│  → Context: 60K tokens (poluído)                             │
│  → Qualidade degrada                                         │
│                                                              │
│  OPÇÃO B (boa): Delegar para sub-agent                       │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ SUB-AGENT (contexto isolado)                            │ │
│  │ ├─ Recebe: arquivo + pergunta específica                │ │
│  │ ├─ Processa: com seus próprios 200K tokens              │ │
│  │ └─ Retorna: resumo de 100 tokens                        │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                              │
│  Main agent recebe resumo                                    │
│  → Context: 50.1K tokens (limpo)                             │
│  → Qualidade mantida                                         │
└──────────────────────────────────────────────────────────────┘</code></pre>

                    <h3>4.6 Quando NÃO Paralelizar</h3>

                    <table class="table-styled">
                        <thead>
                            <tr>
                                <th>Problema</th>
                                <th>Quando Evitar</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Dependências</td><td>Agentes precisam de output um do outro</td></tr>
                            <tr><td>Context total</td><td>Soma dos sub-agents esgota limite</td></tr>
                            <tr><td>Latência crítica</td><td>Overhead de spawn > ganho de paralelismo</td></tr>
                            <tr><td>Tarefas simples</td><td>Uma tarefa de 1 minuto não vale paralelizar</td></tr>
                            <tr><td>Estado compartilhado</td><td>Mutex/lock mais caro que sequencial</td></tr>
                        </tbody>
                    </table>

                    <div class="callout callout-gold">
                        <div class="callout-title">A Regra dos 90%</div>
                        <blockquote>
                            <p>"The goal is not to automate this process 100%. It's something like 90% automation.
                            That's still an order of magnitude productivity lift."</p>
                            <cite>— Robert Brennan, AllHands</cite>
                        </blockquote>
                        <p><strong>Implicação prática:</strong> Não tente 100% de automação. Design para 90% automático
                        + 10% humano. Falhas parciais são aceitáveis. Humano resolve edge cases.</p>
                    </div>
                </section>

                <!-- Bloco 5: Contexto -->
                <section id="bloco5" class="lesson-block">
                    <h2>Bloco 5: Gerenciamento de Contexto</h2>
                    <span class="badge badge-time">25 min</span>

                    <h3>5.1 O "Orçamento" do Modelo</h3>

                    <blockquote>
                        <p>"There's a concept called the dumb zone. Around the 40% line is where you'll
                        start to see some diminishing returns."</p>
                        <cite>— Dex Horthy, HumanLayer</cite>
                    </blockquote>

                    <pre class="diagram"><code>┌──────────────────────────────────────────────────────────────┐
│                    CONTEXT WINDOW                            │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  0%────────────────40%────────────────80%────────────100%    │
│  │                  │                  │               │     │
│  │   SMART ZONE     │  DIMINISHING     │   DUMB ZONE   │     │
│  │                  │   RETURNS        │               │     │
│  │  ✓ Modelo opera  │  ⚠ Performance   │  ✗ Resultados │     │
│  │    bem           │    degrada       │    ruins      │     │
│  │                  │                  │               │     │
└──────────────────────────────────────────────────────────────┘</code></pre>

                    <p><strong>Regra prática:</strong></p>
                    <ul>
                        <li><strong>0-40%:</strong> Zona segura - modelo opera bem</li>
                        <li><strong>40-80%:</strong> Zona de alerta - considere compactar</li>
                        <li><strong>80%+:</strong> Zona de risco - compacte imediatamente</li>
                    </ul>

                    <h3>5.2 Hierarquia de Memória</h3>

                    <pre class="diagram"><code>┌──────────────────────────────────────────────────────────────┐
│  NÍVEL 1: Enterprise Policy (mais geral)                     │
│  └─ /etc/claude-code/CLAUDE.md                               │
├──────────────────────────────────────────────────────────────┤
│  NÍVEL 2: User Memory                                        │
│  └─ ~/.claude/CLAUDE.md                                      │
├──────────────────────────────────────────────────────────────┤
│  NÍVEL 3: Project Memory                                     │
│  └─ ./CLAUDE.md                                              │
├──────────────────────────────────────────────────────────────┤
│  NÍVEL 4: Project Rules                                      │
│  └─ ./.claude/rules/*.md                                     │
├──────────────────────────────────────────────────────────────┤
│  NÍVEL 5: Local Overrides (mais específico)                  │
│  └─ ./CLAUDE.local.md                                        │
└──────────────────────────────────────────────────────────────┘

Precedência: Enterprise < User < Project < Local
(Arquivo posterior vence em caso de conflito)</code></pre>

                    <h3>5.3 Estratégias de Compactação</h3>

                    <p><strong>Auto-Compaction (95%)</strong></p>
                    <p>Claude Code ativa automaticamente quando contexto atinge 95%:</p>
                    <ol>
                        <li>Análise automática do histórico</li>
                        <li>Criação de sumário conciso</li>
                        <li>Substituição de mensagens antigas pelo sumário</li>
                        <li>Continuação transparente da sessão</li>
                    </ol>

                    <p><strong>/compact Manual (70%)</strong></p>
                    <pre><code class="language-bash"># Básico
/compact

# Com instruções customizadas
/compact Focus on code changes and test results

# Preservando padrões
/compact preserve the authentication patterns we established</code></pre>

                    <div class="callout callout-info">
                        <div class="callout-title">Recomendação</div>
                        <p>Use <code>/compact</code> a ~70% para evitar compactação disruptiva automática.</p>
                    </div>

                    <h3>5.5 Economia Estimada</h3>

                    <table class="table-styled">
                        <thead>
                            <tr>
                                <th>Abordagem</th>
                                <th>Tokens/Processo</th>
                                <th>Economia</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Sem engenharia</td><td>200K tokens</td><td>Baseline</td></tr>
                            <tr><td>Com otimizações</td><td>~80K tokens</td><td><strong>60% menos</strong></td></tr>
                            <tr><td>Com subagentes</td><td>~50K tokens</td><td><strong>75% menos</strong></td></tr>
                        </tbody>
                    </table>

                    <p><strong>Impacto:</strong> De $2/processo para $0.40/processo</p>
                </section>

                <!-- Bloco 6: Gates -->
                <section id="bloco6" class="lesson-block">
                    <h2>Bloco 6: Gates e Guardrails</h2>
                    <span class="badge badge-time">35 min</span>

                    <h3>6.1 Por Que Gates São Necessários</h3>

                    <blockquote>
                        <p>"Cost of error and error discovery - If your errors are going to be high stake
                        and very hard to discover, it's going to be very difficult for you to trust the agent."</p>
                        <cite>— Barry Zhang, Anthropic</cite>
                    </blockquote>

                    <p><strong>Gates</strong> = Pontos de verificação onde:</p>
                    <ul>
                        <li>Sistema pausa para validação</li>
                        <li>Humano pode aprovar/rejeitar</li>
                        <li>Erros são detectados antes de propagarem</li>
                    </ul>

                    <h3>6.2 Tipos de Gates</h3>

                    <h4>Gate 1: Input Validation</h4>

                    <pre class="diagram"><code>┌─────────────────────────────────────────────────────────────┐
│  INPUT VALIDATION GATE                                      │
│                                                             │
│  Requisição do Usuário                                      │
│       │                                                     │
│       ▼                                                     │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ Validar:                                              │  │
│  │ ├─ Formato correto?                                   │  │
│  │ ├─ Dentro do escopo permitido?                        │  │
│  │ └─ Ambiguidades?                                      │  │
│  │                                                       │  │
│  │ Se AMBÍGUO: Pedir clarificação ao humano              │  │
│  │ Se INVÁLIDO: Rejeitar com explicação                  │  │
│  │ Se VÁLIDO: Prosseguir                                 │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘</code></pre>

                    <h4>Gate 2: Research Validation</h4>

                    <pre class="diagram"><code>┌─────────────────────────────────────────────────────────────┐
│  RESEARCH VALIDATION GATE                                   │
│                                                             │
│  Após fase de pesquisa:                                     │
│       │                                                     │
│       ▼                                                     │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ CHECKPOINT HUMANO:                                    │  │
│  │ ├─ "As descobertas estão corretas?"                   │  │
│  │ ├─ "Faltou algum arquivo relevante?"                  │  │
│  │ └─ "O entendimento está certo?"                       │  │
│  │                                                       │  │
│  │ Humano: ✓ Aprovar  ✗ Rejeitar  ✎ Pedir revisão       │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘</code></pre>

                    <h4>Gate 4: Automated Validation (Hooks)</h4>

                    <blockquote>
                        <p>"Hooks are a way of doing deterministic verification."</p>
                        <cite>— Thariq Shihipar, Anthropic</cite>
                    </blockquote>

                    <pre class="diagram"><code>┌─────────────────────────────────────────────────────────────┐
│  AUTOMATED VALIDATION GATE (Hooks)                          │
│                                                             │
│  Após execução:                                             │
│       │                                                     │
│       ▼                                                     │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ VERIFICAÇÕES AUTOMÁTICAS:                             │  │
│  │ ├─ Rodar testes unitários                             │  │
│  │ ├─ Verificar linting                                  │  │
│  │ └─ Validar contra requisitos                          │  │
│  │                                                       │  │
│  │ PASS: Continuar automaticamente                       │  │
│  │ FAIL: Loop de correção ou escalação                   │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘</code></pre>

                    <h3>6.3 Matriz de Inserção de Checkpoints</h3>

                    <table class="table-styled">
                        <thead>
                            <tr>
                                <th>Risco</th>
                                <th>Valor</th>
                                <th>Tipo de Checkpoint</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Crítico</td><td>Alto ($$$)</td><td>Humano ANTES da ação</td></tr>
                            <tr><td>Alto</td><td>Alto</td><td>Humano ANTES da ação</td></tr>
                            <tr><td>Alto</td><td>Médio</td><td>Humano DEPOIS, com rollback</td></tr>
                            <tr><td>Médio</td><td>Alto</td><td>Humano DEPOIS</td></tr>
                            <tr><td>Médio</td><td>Médio</td><td>Amostragem (10%)</td></tr>
                            <tr><td>Baixo</td><td>Qualquer</td><td>Evals automáticos apenas</td></tr>
                        </tbody>
                    </table>

                    <h3>6.4 Validação com Evals</h3>

                    <blockquote>
                        <p>"LLMs are still really bad at numbers. Solution: Use text labels (GOOD, ACCEPTABLE, BAD)
                        that map to scores."</p>
                        <cite>— Aman Khan, Arize</cite>
                    </blockquote>

                    <pre class="diagram"><code>┌─────────────────────────────────────────────────────────────┐
│  EVAL-BASED VALIDATION                                      │
│                                                             │
│  Output do Agente                                           │
│       │                                                     │
│       ▼                                                     │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ Prompt de Avaliação:                                  │  │
│  │ "Este output é GOOD, ACCEPTABLE, ou NEEDS_REVIEW?"    │  │
│  │                                                       │  │
│  │ ✓ GOOD (90%+): Pass gate                              │  │
│  │ ⚠ ACCEPTABLE (70-89%): Warn, mas pass                │  │
│  │ ✗ NEEDS_REVIEW (<70%): FAIL gate → humano            │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                             │
│  IMPORTANTE: Use labels textuais, NÃO scores numéricos      │
└─────────────────────────────────────────────────────────────┘</code></pre>
                </section>

                <!-- Bloco 7: Síntese -->
                <section id="bloco7" class="lesson-block">
                    <h2>Bloco 7: Síntese e Projeto</h2>
                    <span class="badge badge-time">10 min</span>

                    <h3>7.1 Arquitetura Completa: Gates em Cadeia</h3>

                    <pre class="diagram"><code>┌──────────────────────────────────────────────────────────────────────────┐
│                      AGENT COM GATES ESTRUTURADO                         │
│                                                                          │
│  ENTRADA                                                                 │
│       │                                                                  │
│  ┌────▼─────────────────────────────────────────────────────────────┐   │
│  │ GATE 1: INPUT VALIDATION                                         │   │
│  └────┬─────────────────────────────────────────────────────────────┘   │
│       │                                                                  │
│  ┌────▼─────────────────────────────────────────────────────────────┐   │
│  │ PHASE 1: RESEARCH (Agent entende problema)                       │   │
│  └────┬─────────────────────────────────────────────────────────────┘   │
│       │                                                                  │
│  ┌────▼─────────────────────────────────────────────────────────────┐   │
│  │ GATE 2: RESEARCH VALIDATION (Humano revisa descobertas)          │   │
│  └────┬─────────────────────────────────────────────────────────────┘   │
│       │                                                                  │
│  ┌────▼─────────────────────────────────────────────────────────────┐   │
│  │ PHASE 2: PLAN (Agent delineia passos)                            │   │
│  └────┬─────────────────────────────────────────────────────────────┘   │
│       │                                                                  │
│  ┌────▼─────────────────────────────────────────────────────────────┐   │
│  │ GATE 3: PLAN APPROVAL (Humano aprova estratégia)                 │   │
│  └────┬─────────────────────────────────────────────────────────────┘   │
│       │                                                                  │
│  ┌────▼─────────────────────────────────────────────────────────────┐   │
│  │ PHASE 3: IMPLEMENT (Agent executa plano)                         │   │
│  └────┬─────────────────────────────────────────────────────────────┘   │
│       │                                                                  │
│  ┌────▼─────────────────────────────────────────────────────────────┐   │
│  │ GATE 4: AUTOMATED VALIDATION (Hooks - testes, linting)           │   │
│  └────┬─────────────────────────────────────────────────────────────┘   │
│       │                                                                  │
│  ┌────▼─────────────────────────────────────────────────────────────┐   │
│  │ GATE 5: CONTEXT CHECK (Se >40%, compactar)                       │   │
│  └────┬─────────────────────────────────────────────────────────────┘   │
│       │                                                                  │
│  ┌────▼─────────────────────────────────────────────────────────────┐   │
│  │ PHASE 4: VERIFICATION (Evals finais)                             │   │
│  └────┬─────────────────────────────────────────────────────────────┘   │
│       │                                                                  │
│  ┌────▼─────────────────────────────────────────────────────────────┐   │
│  │ GATE 6: QA CHECKPOINT (LLM-as-judge)                             │   │
│  └────┬─────────────────────────────────────────────────────────────┘   │
│       │                                                                  │
│  SAÍDA (Resultado aprovado, testado, validado)                          │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘</code></pre>

                    <h3>7.2 Checklist de Arquitetura</h3>

                    <p>Ao projetar um sistema agêntico, pergunte-se:</p>

                    <h4>1. Workflow vs Agent</h4>
                    <ul>
                        <li>Tarefas são previsíveis? → Workflow</li>
                        <li>Precisa de exploração? → Agent</li>
                        <li>Híbrido? → Workflow com bolsões agênticos</li>
                    </ul>

                    <h4>2. Orquestração</h4>
                    <ul>
                        <li>Quem decide a rota? (Regras, LLM, Humano)</li>
                        <li>Supervisão centralizada ou distribuída?</li>
                        <li>Onde estão os checkpoints humanos?</li>
                    </ul>

                    <h4>3. Pipeline</h4>
                    <ul>
                        <li>Etapas são sequenciais ou podem paralelizar?</li>
                        <li>Padrão RPI aplica-se? (Research → Plan → Implement)</li>
                        <li>Feedback iterativo necessário?</li>
                    </ul>

                    <h4>4. Paralelização</h4>
                    <ul>
                        <li>Tarefas são independentes? → Fan-out</li>
                        <li>Como consolidar resultados? → Fan-in</li>
                        <li>Meta: 90% automação (não 100%)</li>
                    </ul>

                    <h4>5. Contexto</h4>
                    <ul>
                        <li>Context window será lotado? → Subagentes</li>
                        <li>Quando compactar? → 40% threshold</li>
                        <li>Hierarquia de memória definida?</li>
                    </ul>

                    <h4>6. Gates</h4>
                    <ul>
                        <li>Gates de input validation?</li>
                        <li>Gates de research/plan approval?</li>
                        <li>Gates automáticos (hooks)?</li>
                        <li>Gates de QA (evals)?</li>
                        <li>Error handling definido?</li>
                    </ul>

                    <h3>7.3 Preparação para Aula 4</h3>

                    <p>Na próxima aula, vamos <strong>construir</strong> esses padrões:</p>
                    <ul>
                        <li>Implementar um pipeline simples</li>
                        <li>Configurar gates com hooks</li>
                        <li>Criar subagentes para paralelização</li>
                        <li>Testar com um caso real</li>
                    </ul>

                    <h3>Citações-Chave da Aula</h3>

                    <table class="table-styled">
                        <thead>
                            <tr>
                                <th>Especialista</th>
                                <th>Citação</th>
                                <th>Conceito</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Dex Horthy</td>
                                <td>"Most production agents weren't that agentic at all."</td>
                                <td>Híbrido workflow+agent</td>
                            </tr>
                            <tr>
                                <td>Michele Catasta</td>
                                <td>"The core loop as the orchestrator..."</td>
                                <td>Orquestração</td>
                            </tr>
                            <tr>
                                <td>Robert Brennan</td>
                                <td>"90% automation is an order of magnitude productivity lift."</td>
                                <td>Paralelização</td>
                            </tr>
                            <tr>
                                <td>Dex Horthy</td>
                                <td>"Around the 40% line is where diminishing returns start."</td>
                                <td>Context management</td>
                            </tr>
                            <tr>
                                <td>Barry Zhang</td>
                                <td>"High stake errors need more human-in-the-loop."</td>
                                <td>Gates</td>
                            </tr>
                        </tbody>
                    </table>
                </section>

                <!-- Navigation -->
                <nav class="lesson-navigation">
                    <a href="aula-2b.html" class="nav-prev">
                        <span class="nav-label">Anterior</span>
                        <span class="nav-title">Aula 2B: Claude Code</span>
                    </a>
                    <a href="aula-4.html" class="nav-next">
                        <span class="nav-label">Próxima</span>
                        <span class="nav-title">Aula 4: Construindo</span>
                    </a>
                </nav>
            </div>
        </div>

        <!-- Mobile TOC -->
        <div class="mobile-toc">
            <button class="mobile-toc-trigger">
                <span>Navegação</span>
                <svg viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
            <nav class="mobile-toc-content">
                <a href="#bloco1">1. Workflow vs Agent</a>
                <a href="#bloco2">2. Orquestração</a>
                <a href="#bloco3">3. Pipelines</a>
                <a href="#bloco4">4. Paralelização</a>
                <a href="#bloco5">5. Contexto</a>
                <a href="#bloco6">6. Gates</a>
                <a href="#bloco7">7. Síntese</a>
            </nav>
        </div>
    </main>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="footer-content">
            <div class="footer-section">
                <h4>Sistemas Agênticos</h4>
                <p>Curso prático de IA Agêntica para profissionais do Direito.</p>
            </div>
            <div class="footer-section">
                <h4>Navegação</h4>
                <ul>
                    <li><a href="../index.html">Início</a></li>
                    <li><a href="glossario.html">Glossário</a></li>
                    <li><a href="recursos.html">Recursos</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Aulas</h4>
                <ul>
                    <li><a href="aula-0.html">Aula 0: Abertura</a></li>
                    <li><a href="aula-1.html">Aula 1: Sistema na Prática</a></li>
                    <li><a href="aula-2a.html">Aula 2A: Anatomia</a></li>
                    <li><a href="aula-2b.html">Aula 2B: Claude Code</a></li>
                    <li><a href="aula-3.html">Aula 3: Arquitetura</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>Baseado no paradigma de <strong>Regência Cognitiva</strong></p>
        </div>
    </footer>

    <script src="../js/main.js"></script>
</body>
</html>
