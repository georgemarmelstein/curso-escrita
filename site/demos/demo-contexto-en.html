<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo: Context Window</title>

    <!-- Google Fonts: Crimson Pro + Source Sans 3 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;500;600;700&family=Source+Sans+3:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #194A68;
            --primary-light: #2a6a8f;
            --gold: #BE9C6D;
            --gold-light: #d4b896;
            --cream: #FFF4E4;
            --cream-dark: #f5e6d3;
            --text-primary: #1a1a1a;
            --text-secondary: #555;
            --border-light: rgba(25, 74, 104, 0.15);
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Source Sans 3', -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, var(--cream-dark) 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px;
            color: var(--text-primary);
        }

        body.embed-mode { padding: 12px; min-height: auto; height: 100vh; overflow: hidden; }
        body.embed-mode h1, body.embed-mode .subtitle { display: none; }
        body.embed-mode .demo-container { height: 100%; gap: 16px; }
        body.embed-mode .context-window { min-height: auto; padding: 14px; }
        body.embed-mode .controls-panel { padding: 14px; max-width: 260px; }
        body.embed-mode .blocks-area { min-height: 200px; padding: 12px; }
        body.embed-mode .block { padding: 8px 12px; }
        body.embed-mode .block-icon { font-size: 1.2em; width: 28px; }
        body.embed-mode .block-name { font-size: 0.8em; }
        body.embed-mode .block-size { font-size: 0.65em; }
        body.embed-mode .add-btn { padding: 8px 10px; font-size: 0.8em; }
        body.embed-mode .mode-toggle { margin-bottom: 10px; }
        body.embed-mode .mode-btn { padding: 6px 8px; font-size: 0.7em; }
        body.embed-mode .cost-explanation { display: none; }
        body.embed-mode .external-storage { margin-top: 10px; padding: 10px; }

        h1 { font-family: 'Crimson Pro', Georgia, serif; color: var(--primary); margin-bottom: 8px; font-size: 1.6em; font-weight: 600; }
        .subtitle { color: var(--text-secondary); margin-bottom: 24px; font-size: 0.95em; }
        .demo-container { display: flex; gap: 24px; max-width: 1100px; width: 100%; }

        .context-window { flex: 2; background: white; border-radius: 16px; border: 1px solid var(--border-light); padding: 20px; min-height: 480px; position: relative; box-shadow: var(--shadow-md); }
        .context-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid var(--cream-dark); flex-wrap: wrap; gap: 10px; }
        .context-title { font-family: 'Crimson Pro', Georgia, serif; font-size: 1.1em; color: var(--primary); font-weight: 600; }
        .header-indicators { display: flex; gap: 12px; align-items: center; }

        .cost-indicator { display: flex; flex-direction: column; align-items: flex-end; padding: 6px 12px; background: var(--cream); border-radius: 8px; border: 1px solid var(--border-light); }
        .cost-label { font-size: 0.65em; color: var(--text-secondary); text-transform: uppercase; }
        .cost-value { font-family: 'JetBrains Mono', monospace; font-size: 0.95em; font-weight: 600; color: var(--primary); }

        .fill-bar-container { width: 160px; height: 24px; background: var(--cream-dark); border: 1px solid var(--border-light); border-radius: 12px; overflow: hidden; position: relative; }
        .fill-bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--gold-light), var(--gold)); border-radius: 12px; transition: all 0.5s ease; }
        .fill-bar.warning { background: linear-gradient(90deg, #fbbf24, #f59e0b); }
        .fill-bar.danger { background: linear-gradient(90deg, #f87171, #ef4444); }
        .fill-bar.critical { background: linear-gradient(90deg, #dc2626, #991b1b); animation: pulse-critical 0.5s ease infinite; }
        @keyframes pulse-critical { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .fill-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.75em; font-weight: 600; color: var(--text-primary); }

        .blocks-area { display: flex; flex-direction: column; gap: 8px; min-height: 300px; padding: 16px; background: var(--cream); border-radius: 12px; border: 2px dashed var(--border-light); position: relative; }
        .blocks-area.drag-over { border-color: var(--primary); background: rgba(25, 74, 104, 0.05); }
        .empty-hint { text-align: center; color: var(--text-secondary); font-size: 0.9em; padding: 40px 20px; }

        .block { background: white; border-radius: 10px; padding: 12px 16px; display: flex; align-items: center; gap: 12px; border: 1px solid var(--border-light); animation: block-enter 0.3s ease; transition: all 0.4s ease; box-shadow: var(--shadow-sm); position: relative; cursor: grab; }
        .block:active { cursor: grabbing; }
        .block.dragging { opacity: 0.5; transform: scale(0.98); }
        .block.drag-over { border-color: var(--primary); border-width: 2px; }
        @keyframes block-enter { from { opacity: 0; transform: translateY(-10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }

        .block-order { position: absolute; top: -8px; left: -8px; width: 20px; height: 20px; background: var(--primary); color: white; border-radius: 50%; font-size: 0.65em; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .block-delete { position: absolute; top: -8px; right: -8px; width: 20px; height: 20px; background: var(--color-danger); color: white; border-radius: 50%; font-size: 0.7em; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; transition: all 0.2s ease; }
        .block:hover .block-delete { opacity: 1; }
        .block-delete:hover { transform: scale(1.1); }
        .block-icon { font-size: 1.5em; width: 36px; text-align: center; }
        .block-content { flex: 1; }
        .block-name { font-weight: 600; font-size: 0.9em; color: var(--text-primary); }
        .block-size { font-size: 0.75em; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace; }

        .block.fade-level-1 { opacity: 0.85; }
        .block.fade-level-2 { opacity: 0.7; filter: grayscale(15%); }
        .block.fade-level-3 { opacity: 0.55; filter: grayscale(30%); }
        .block.fade-level-4 { opacity: 0.4; filter: grayscale(45%) blur(0.5px); }
        .block.fade-level-5 { opacity: 0.25; filter: grayscale(60%) blur(1px); }
        .block.fade-level-6 { opacity: 0.15; filter: grayscale(75%) blur(1.5px); pointer-events: none; }

        .block.system.fade-level-1, .block.system.fade-level-2, .block.system.fade-level-3,
        .block.system.fade-level-4, .block.system.fade-level-5, .block.system.fade-level-6 {
            opacity: 1 !important; filter: none !important; pointer-events: auto !important;
        }

        .block.sliding-out { animation: slide-out 0.5s ease forwards; }
        @keyframes slide-out { to { opacity: 0; transform: translateX(-30px) scale(0.9); max-height: 0; padding: 0; margin: 0; } }

        .block.system { border-left: 4px solid var(--gold); background: linear-gradient(90deg, rgba(190,156,109,0.12), white); }
        .block.user { border-left: 4px solid var(--primary); background: linear-gradient(90deg, rgba(25,74,104,0.08), white); }
        .block.response { border-left: 4px solid var(--color-success); background: linear-gradient(90deg, rgba(16,185,129,0.08), white); }
        .block.attachment { border-left: 4px solid #8b5cf6; background: linear-gradient(90deg, rgba(139,92,246,0.08), white); }
        .block.web { border-left: 4px solid #06b6d4; background: linear-gradient(90deg, rgba(6,182,212,0.08), white); }
        .block.compacted { border-left: 4px solid var(--gold); border-style: dashed; background: linear-gradient(90deg, rgba(190,156,109,0.2), white); }
        .block.chunk { border-left: 4px solid #a855f7; background: linear-gradient(90deg, rgba(168,85,247,0.08), white); padding: 8px 12px; }
        .block.chunk .block-icon { font-size: 1.2em; width: 28px; }

        .status-message { position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border-radius: 8px; font-size: 0.85em; font-weight: 500; opacity: 0; transition: opacity 0.3s ease; text-align: center; max-width: 90%; }
        .status-message.visible { opacity: 1; }
        .status-message.info { background: rgba(25,74,104,0.1); border: 1px solid var(--primary-light); color: var(--primary); }
        .status-message.warning { background: rgba(245,158,11,0.15); border: 1px solid #f59e0b; color: #b45309; }
        .status-message.error { background: rgba(239,68,68,0.15); border: 1px solid #ef4444; color: #dc2626; animation: shake 0.4s ease; }
        @keyframes shake { 0%, 100% { transform: translateX(-50%); } 25% { transform: translateX(calc(-50% - 5px)); } 75% { transform: translateX(calc(-50% + 5px)); } }

        .external-storage { margin-top: 16px; background: var(--cream); border: 2px dashed var(--border-light); border-radius: 12px; padding: 14px; display: none; }
        .external-storage.visible { display: block; animation: fade-in 0.3s ease; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .storage-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid var(--border-light); }
        .storage-title { font-family: 'Crimson Pro', Georgia, serif; color: var(--primary); font-size: 0.9em; font-weight: 600; }
        .storage-subtitle { font-size: 0.7em; color: var(--text-secondary); }
        .storage-area { display: flex; flex-wrap: wrap; gap: 10px; min-height: 40px; }
        .storage-hint { color: var(--text-secondary); font-size: 0.75em; text-align: center; width: 100%; padding: 8px; }

        .stored-doc { background: white; border: 1px solid var(--border-light); border-radius: 8px; padding: 8px 12px; display: flex; align-items: center; gap: 8px; position: relative; box-shadow: var(--shadow-sm); }
        .stored-doc .doc-icon { font-size: 1.3em; }
        .stored-doc .doc-info { display: flex; flex-direction: column; }
        .stored-doc .doc-name { font-size: 0.8em; font-weight: 600; }
        .stored-doc .doc-size { font-size: 0.65em; color: var(--text-secondary); }
        .stored-doc .doc-status { font-size: 0.6em; color: var(--color-success); }
        .stored-doc .doc-delete { position: absolute; top: -6px; right: -6px; width: 16px; height: 16px; background: var(--color-danger); color: white; border-radius: 50%; font-size: 0.6em; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; transition: opacity 0.2s; }
        .stored-doc:hover .doc-delete { opacity: 1; }
        .stored-doc.searching { animation: doc-search 0.5s ease infinite; }
        @keyframes doc-search { 0%, 100% { box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.4); } 50% { box-shadow: 0 0 15px 3px rgba(168, 85, 247, 0.6); } }

        .controls-panel { flex: 1; background: white; border-radius: 16px; border: 1px solid var(--border-light); padding: 20px; box-shadow: var(--shadow-md); max-width: 300px; display: flex; flex-direction: column; gap: 16px; }
        .controls-title { font-family: 'Crimson Pro', Georgia, serif; color: var(--primary); font-size: 0.95em; font-weight: 600; display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }

        .mode-toggle { display: flex; background: var(--cream); border-radius: 8px; padding: 3px; border: 1px solid var(--border-light); margin-bottom: 12px; }
        .mode-btn { flex: 1; padding: 8px 6px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; border-radius: 6px; font-family: 'Source Sans 3', sans-serif; font-size: 0.75em; font-weight: 500; transition: all 0.2s ease; display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .mode-btn .mode-icon { font-size: 1.2em; }
        .mode-btn:hover { color: var(--text-primary); }
        .mode-btn.active { background: var(--primary); color: white; box-shadow: var(--shadow-sm); }

        .add-buttons { display: flex; flex-direction: column; gap: 6px; }
        .add-btn { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border: 1px solid var(--border-light); border-radius: 8px; cursor: pointer; font-family: 'Source Sans 3', sans-serif; font-size: 0.85em; font-weight: 500; transition: all 0.2s ease; background: var(--cream); color: var(--text-primary); }
        .add-btn:hover { background: var(--primary); color: white; transform: translateX(3px); }
        .add-btn:active { transform: scale(0.98); }
        .add-btn .icon { font-size: 1.1em; width: 22px; text-align: center; }

        .action-buttons { display: flex; gap: 8px; }
        .compact-btn { flex: 1; padding: 10px; background: var(--gold); border: none; border-radius: 8px; cursor: pointer; font-family: 'Source Sans 3', sans-serif; font-size: 0.8em; font-weight: 600; color: white; transition: all 0.2s ease; }
        .compact-btn:hover { background: var(--gold-light); transform: scale(1.02); }
        .compact-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .reset-btn { padding: 10px 14px; background: var(--cream); border: 1px solid var(--border-light); border-radius: 8px; cursor: pointer; font-family: 'Source Sans 3', sans-serif; font-size: 0.8em; font-weight: 500; color: var(--text-secondary); transition: all 0.2s ease; }
        .reset-btn:hover { background: var(--cream-dark); color: var(--text-primary); }

        .cost-explanation { padding: 12px; background: var(--cream); border-radius: 8px; font-size: 0.75em; color: var(--text-secondary); line-height: 1.5; }
        .cost-explanation h4 { font-family: 'Crimson Pro', Georgia, serif; color: var(--primary); margin-bottom: 6px; font-size: 0.95em; }
        .cost-formula { background: white; padding: 6px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; text-align: center; color: var(--primary); margin: 8px 0; }

        .context-window.collapse { animation: collapse-shake 0.6s ease; }
        @keyframes collapse-shake { 0%, 100% { transform: rotate(0); } 10%, 30%, 50%, 70%, 90% { transform: rotate(-1deg); } 20%, 40%, 60%, 80% { transform: rotate(1deg); } }

        [data-tooltip] { position: relative; }
        [data-tooltip]::after { content: attr(data-tooltip); position: absolute; bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%); background: var(--text-primary); color: white; padding: 8px 12px; border-radius: 6px; font-size: 0.75em; font-weight: 400; white-space: normal; width: max-content; max-width: 220px; text-align: center; opacity: 0; visibility: hidden; transition: all 0.2s ease; z-index: 100; pointer-events: none; line-height: 1.4; box-shadow: var(--shadow-md); }
        [data-tooltip]::before { content: ''; position: absolute; bottom: calc(100% + 2px); left: 50%; transform: translateX(-50%); border: 6px solid transparent; border-top-color: var(--text-primary); opacity: 0; visibility: hidden; transition: all 0.2s ease; z-index: 100; }
        [data-tooltip]:hover::after, [data-tooltip]:hover::before { opacity: 1; visibility: visible; }
        .action-buttons [data-tooltip]::after, .header-indicators [data-tooltip]::after { bottom: auto; top: calc(100% + 8px); }
        .action-buttons [data-tooltip]::before, .header-indicators [data-tooltip]::before { bottom: auto; top: calc(100% + 2px); border-top-color: transparent; border-bottom-color: var(--text-primary); }

        @media (max-width: 800px) {
            .demo-container { flex-direction: column; }
            .controls-panel { order: -1; max-width: none; }
            .add-buttons { flex-direction: row; flex-wrap: wrap; }
            .add-btn { flex: 1; min-width: 100px; }
        }
    </style>
</head>
<body>
    <h1>The Context Window</h1>
    <p class="subtitle">Simulate a conversation and see how the window fills up</p>

    <div class="demo-container">
        <div class="context-window" id="contextWindow">
            <div class="context-header">
                <span class="context-title">Context Window (200K tokens)</span>
                <div class="header-indicators">
                    <div class="cost-indicator" data-tooltip="How much you would pay for EACH AI response with this accumulated context.">
                        <span class="cost-label">Cost/Response</span>
                        <span class="cost-value" id="costValue">$0.00</span>
                    </div>
                    <div class="fill-bar-container" data-tooltip="Percentage of context window used. 100% = limit reached.">
                        <div class="fill-bar" id="fillBar"></div>
                        <span class="fill-text" id="fillText">0%</span>
                    </div>
                </div>
            </div>

            <div class="blocks-area" id="blocksArea">
                <div class="empty-hint" id="emptyHint">Click the buttons on the side to simulate a conversation</div>
            </div>

            <div class="status-message" id="statusMessage"></div>

            <div class="external-storage" id="externalStorage">
                <div class="storage-header">
                    <span class="storage-title">External Storage</span>
                    <span class="storage-subtitle">Indexed documents (outside context)</span>
                </div>
                <div class="storage-area" id="storageArea">
                    <div class="storage-hint" id="storageHint">In RAG mode, attachments stay here and only chunks enter the context</div>
                </div>
            </div>
        </div>

        <div class="controls-panel">
            <div>
                <h3 class="controls-title">Attachment Mode</h3>
                <div class="mode-toggle">
                    <button class="mode-btn active" id="modeStuffing" onclick="setParadigm('stuffing')" data-tooltip="ENTIRE document enters the context window. Simple, but consumes a lot of space.">
                        <span class="mode-icon">üìÑ</span><span>Stuffing</span>
                    </button>
                    <button class="mode-btn" id="modeRAG" onclick="setParadigm('rag')" data-tooltip="Document stays in external database. Only relevant chunks enter the context. More efficient!">
                        <span class="mode-icon">üîç</span><span>RAG</span>
                    </button>
                </div>
            </div>

            <div>
                <h3 class="controls-title">When Overflow</h3>
                <div class="mode-toggle">
                    <button class="mode-btn active" id="modeCollapse" onclick="setMode('collapse')" data-tooltip="When reaching 100%, the AI STOPS working. Total error. This is the default behavior of most APIs.">
                        <span class="mode-icon">üí•</span><span>Collapse</span>
                    </button>
                    <button class="mode-btn" id="modeSliding" onclick="setMode('sliding')" data-tooltip="Old messages 'fade' to make room for new ones. The AI forgets the beginning of the conversation.">
                        <span class="mode-icon">üîÑ</span><span>Sliding</span>
                    </button>
                </div>
            </div>

            <div>
                <h3 class="controls-title">Add Elements</h3>
                <div class="add-buttons" id="addButtons">
                    <button class="add-btn" draggable="true" data-type="system" onclick="addBlock('system')" data-tooltip="Invisible instructions that define the AI's behavior. Always present, never forgotten.">
                        <span class="icon">ü§ñ</span><span>System Prompt</span>
                    </button>
                    <button class="add-btn" draggable="true" data-type="user" onclick="addBlock('user')" data-tooltip="Your message to the AI. Usually small (~1K tokens).">
                        <span class="icon">üí¨</span><span>Your Question</span>
                    </button>
                    <button class="add-btn" draggable="true" data-type="response" onclick="addBlock('response')" data-tooltip="Response generated by the AI. Also takes up space in the window!">
                        <span class="icon">ü§ñ</span><span>AI Response</span>
                    </button>
                    <button class="add-btn" draggable="true" data-type="attachment" onclick="addBlock('attachment')" data-tooltip="Attached PDF document. VERY large (~30K tokens). Main culprit of context consumption!">
                        <span class="icon">üìé</span><span>Attach PDF</span>
                    </button>
                    <button class="add-btn" draggable="true" data-type="web" onclick="addBlock('web')" data-tooltip="Internet search result. Brings a lot of content (~18K tokens).">
                        <span class="icon">üåê</span><span>Web Search</span>
                    </button>
                </div>
            </div>

            <div class="action-buttons">
                <button class="compact-btn" onclick="compactContext()" data-tooltip="Summarizes the entire conversation into a smaller block (20% of size). Loses details, but frees space.">üì¶ Compact</button>
                <button class="reset-btn" onclick="resetDemo()" data-tooltip="Clears everything and starts from zero.">üîÑ Reset</button>
            </div>

            <div class="cost-explanation">
                <h4>Why does cost increase?</h4>
                <p>Each AI response processes <strong>ALL</strong> accumulated context.</p>
                <div class="cost-formula">Cost = Tokens √ó $0.003 / 1K</div>
                <p><strong>Collapse:</strong> When reaching 100%, everything fails.<br><strong>Sliding:</strong> Old blocks "fade" - the AI forgets the beginning.</p>
            </div>
        </div>
    </div>

    <script>
        const blockTypes = {
            system: { icon: 'ü§ñ', name: 'System Prompt', size: 1.5, sizeText: '3K tokens (1.5%)', tokens: 3000 },
            user: { icon: 'üí¨', name: 'Your Question', size: 0.5, sizeText: '1K tokens (0.5%)', tokens: 1000 },
            response: { icon: 'ü§ñ', name: 'AI Response', size: 1.5, sizeText: '3K tokens (1.5%)', tokens: 3000 },
            attachment: { icon: 'üìé', name: 'PDF Attachment', size: 15, sizeText: '30K tokens (15%)', tokens: 30000 },
            web: { icon: 'üåê', name: 'Web Search', size: 9, sizeText: '18K tokens (9%)', tokens: 18000 },
            compacted: { icon: 'üì¶', name: 'Compacted Conversation', size: 0, sizeText: '', tokens: 0 },
            chunk1: { icon: 'üß©', name: 'Chunk 1', size: 1, sizeText: '2K tokens (1%)', tokens: 2000 },
            chunk2: { icon: 'üß©', name: 'Chunk 2', size: 1, sizeText: '2K tokens (1%)', tokens: 2000 },
            chunk3: { icon: 'üß©', name: 'Chunk 3', size: 0.5, sizeText: '1K tokens (0.5%)', tokens: 1000 }
        };

        const pricePerThousand = 0.003;
        let blocks = [], blockCounter = 0, mode = 'collapse', paradigm = 'stuffing', storedDocuments = [], docCounter = 0, draggedBlock = null;

        function setParadigm(newParadigm) {
            paradigm = newParadigm;
            document.getElementById('modeStuffing').classList.toggle('active', paradigm === 'stuffing');
            document.getElementById('modeRAG').classList.toggle('active', paradigm === 'rag');
            const externalStorage = document.getElementById('externalStorage');
            if (paradigm === 'rag') { externalStorage.classList.add('visible'); showStatus('RAG Mode: Attachments stay in external storage, only chunks enter the context.', 'info'); }
            else { externalStorage.classList.remove('visible'); showStatus('Stuffing Mode: Attachments enter entirely in the context window.', 'info'); }
            setTimeout(hideStatus, 3000);
        }

        function setMode(newMode) {
            mode = newMode;
            document.getElementById('modeCollapse').classList.toggle('active', mode === 'collapse');
            document.getElementById('modeSliding').classList.toggle('active', mode === 'sliding');
            blocks.forEach(b => { for (let i = 1; i <= 6; i++) b.element.classList.remove(`fade-level-${i}`); b.element.classList.remove('sliding-out'); });
            updateVisuals();
        }

        function addBlock(type) {
            if (paradigm === 'rag' && (type === 'attachment' || type === 'web')) { addToExternalStorage(type); if (blocks.some(b => b.type === 'user')) setTimeout(retrieveChunks, 500); return; }
            const blockInfo = blockTypes[type];
            const hint = document.getElementById('emptyHint'); if (hint) hint.style.display = 'none';
            const block = document.createElement('div');
            block.className = `block ${type}`; block.id = `block-${blockCounter}`; block.draggable = true;
            block.innerHTML = `<span class="block-order">${blocks.length + 1}</span><span class="block-delete" onclick="deleteBlock('${block.id}', event)">‚úï</span><span class="block-icon">${blockInfo.icon}</span><div class="block-content"><span class="block-name">${blockInfo.name}</span><span class="block-size">${blockInfo.sizeText}</span></div>`;
            const blockData = { id: block.id, type: type, size: blockInfo.size, tokens: blockInfo.tokens, element: block, order: blocks.length + 1 };
            setupBlockDrag(block, blockData); blocks.push(blockData); document.getElementById('blocksArea').appendChild(block); blockCounter++;
            if (paradigm === 'rag' && type === 'user' && storedDocuments.length > 0) setTimeout(retrieveChunks, 500);
            updateVisuals();
        }

        function addToExternalStorage(type) {
            const blockInfo = blockTypes[type]; const storageArea = document.getElementById('storageArea');
            const hint = document.getElementById('storageHint'); if (hint) hint.style.display = 'none';
            const doc = document.createElement('div'); doc.className = 'stored-doc'; doc.id = `doc-${docCounter}`;
            doc.innerHTML = `<span class="doc-delete" onclick="removeStoredDoc('${doc.id}', event)">‚úï</span><span class="doc-icon">${blockInfo.icon}</span><div class="doc-info"><span class="doc-name">${blockInfo.name}</span><span class="doc-size">${blockInfo.sizeText}</span><span class="doc-status">‚úì Indexed</span></div>`;
            storedDocuments.push({ id: doc.id, type: type, tokens: blockInfo.tokens, size: blockInfo.size, element: doc });
            storageArea.appendChild(doc); docCounter++;
            showStatus(`${blockInfo.name} indexed. Add a question to fetch chunks!`, 'info'); setTimeout(hideStatus, 3000);
        }

        function removeStoredDoc(docId, event) {
            if (event) { event.stopPropagation(); event.preventDefault(); }
            const docIndex = storedDocuments.findIndex(d => d.id === docId); if (docIndex === -1) return;
            const docData = storedDocuments[docIndex]; docData.element.style.opacity = '0'; docData.element.style.transform = 'scale(0.8)';
            setTimeout(() => { docData.element.remove(); storedDocuments.splice(docIndex, 1); if (storedDocuments.length === 0) { const hint = document.getElementById('storageHint'); if (hint) hint.style.display = 'block'; } }, 300);
        }

        function retrieveChunks() {
            if (storedDocuments.length === 0) return;
            storedDocuments.forEach(doc => doc.element.classList.add('searching'));
            setTimeout(() => {
                storedDocuments.forEach(doc => doc.element.classList.remove('searching'));
                const chunksToAdd = ['chunk1', 'chunk2', 'chunk3'];
                chunksToAdd.forEach((chunkType, index) => setTimeout(() => addChunkBlock(chunkType), index * 150));
                showStatus(`Retrieval: ${chunksToAdd.length} chunks found and added!`, 'info'); setTimeout(hideStatus, 3000);
            }, 600);
        }

        function addChunkBlock(chunkType) {
            const blockInfo = blockTypes[chunkType];
            const hint = document.getElementById('emptyHint'); if (hint) hint.style.display = 'none';
            const block = document.createElement('div'); block.className = 'block chunk'; block.id = `block-${blockCounter}`;
            block.innerHTML = `<span class="block-order">${blocks.length + 1}</span><span class="block-delete" onclick="deleteBlock('${block.id}', event)">‚úï</span><span class="block-icon">${blockInfo.icon}</span><div class="block-content"><span class="block-name">${blockInfo.name}</span><span class="block-size">${blockInfo.sizeText}</span></div>`;
            const blockData = { id: block.id, type: chunkType, size: blockInfo.size, tokens: blockInfo.tokens, element: block, order: blocks.length + 1 };
            blocks.push(blockData); document.getElementById('blocksArea').appendChild(block); blockCounter++;
            updateVisuals();
        }

        function deleteBlock(blockId, event) {
            if (event) { event.stopPropagation(); event.preventDefault(); }
            const blockIndex = blocks.findIndex(b => b.id === blockId); if (blockIndex === -1) return;
            const blockData = blocks[blockIndex]; blockData.element.style.opacity = '0'; blockData.element.style.transform = 'scale(0.9)';
            setTimeout(() => { blockData.element.remove(); blocks.splice(blockIndex, 1); updateBlockOrders(); updateVisuals(); if (blocks.length === 0) { const hint = document.getElementById('emptyHint'); if (hint) hint.style.display = 'block'; } }, 200);
        }

        function updateBlockOrders() { blocks.forEach((block, index) => { block.order = index + 1; const orderEl = block.element.querySelector('.block-order'); if (orderEl) orderEl.textContent = index + 1; }); }

        function compactContext() {
            const nonSystemBlocks = blocks.filter(b => b.type !== 'system' && b.type !== 'compacted');
            if (nonSystemBlocks.length < 2) { showStatus('Nothing to compact yet!', 'warning'); setTimeout(hideStatus, 2000); return; }
            const totalSize = nonSystemBlocks.reduce((sum, b) => sum + b.size, 0);
            const totalTokens = nonSystemBlocks.reduce((sum, b) => sum + b.tokens, 0);
            const compactedSize = totalSize * 0.2; const compactedTokens = Math.round(totalTokens * 0.2);
            nonSystemBlocks.forEach((b, i) => setTimeout(() => { b.element.style.opacity = '0'; b.element.style.transform = 'scale(0.9)'; }, i * 50));
            setTimeout(() => {
                nonSystemBlocks.forEach(b => { b.element.remove(); const index = blocks.findIndex(bl => bl.id === b.id); if (index > -1) blocks.splice(index, 1); });
                const block = document.createElement('div'); block.className = 'block compacted'; block.id = `block-${blockCounter}`;
                block.innerHTML = `<span class="block-order">${blocks.length + 1}</span><span class="block-delete" onclick="deleteBlock('${block.id}', event)">‚úï</span><span class="block-icon">üì¶</span><div class="block-content"><span class="block-name">Compacted Conversation</span><span class="block-size">${Math.round(compactedTokens/1000)}K tokens (${compactedSize.toFixed(1)}%)</span></div>`;
                const blockData = { id: block.id, type: 'compacted', size: compactedSize, tokens: compactedTokens, element: block, order: blocks.length + 1 };
                blocks.push(blockData); document.getElementById('blocksArea').appendChild(block); blockCounter++;
                updateBlockOrders(); updateVisuals();
                showStatus(`Compacted! Savings of ${Math.round((1 - 0.2) * 100)}% tokens.`, 'info'); setTimeout(hideStatus, 3000);
            }, nonSystemBlocks.length * 50 + 300);
        }

        function updateVisuals() {
            const totalSize = blocks.reduce((sum, b) => sum + b.size, 0);
            const totalTokens = blocks.reduce((sum, b) => sum + b.tokens, 0);
            const fillBar = document.getElementById('fillBar'); const fillText = document.getElementById('fillText');
            const displayPercent = mode === 'sliding' ? Math.min(totalSize, 100) : totalSize;
            fillBar.style.width = Math.min(displayPercent, 100) + '%'; fillText.textContent = Math.round(totalSize) + '%';
            fillBar.classList.remove('warning', 'danger', 'critical');
            if (totalSize >= 100) fillBar.classList.add(mode === 'collapse' ? 'critical' : 'danger');
            else if (totalSize >= 80) fillBar.classList.add('danger');
            else if (totalSize >= 60) fillBar.classList.add('warning');
            const cost = (totalTokens / 1000) * pricePerThousand;
            document.getElementById('costValue').textContent = '$' + cost.toFixed(2);
            if (mode === 'sliding' && totalSize > 100) {
                const overflow = totalSize - 100; let accumulated = 0;
                blocks.forEach(block => {
                    for (let i = 1; i <= 6; i++) block.element.classList.remove(`fade-level-${i}`);
                    accumulated += block.size;
                    if (block.type === 'system') return;
                    const fadeThreshold = overflow;
                    if (accumulated <= fadeThreshold) block.element.classList.add('fade-level-6');
                    else if (accumulated <= fadeThreshold + 5) block.element.classList.add('fade-level-5');
                    else if (accumulated <= fadeThreshold + 10) block.element.classList.add('fade-level-4');
                    else if (accumulated <= fadeThreshold + 15) block.element.classList.add('fade-level-3');
                    else if (accumulated <= fadeThreshold + 20) block.element.classList.add('fade-level-2');
                    else if (accumulated <= fadeThreshold + 25) block.element.classList.add('fade-level-1');
                });
                showStatus('Sliding window: old blocks are being "forgotten"...', 'warning');
            } else if (mode === 'collapse' && totalSize >= 100) {
                document.getElementById('contextWindow').classList.add('collapse');
                setTimeout(() => document.getElementById('contextWindow').classList.remove('collapse'), 600);
                showStatus('COLLAPSE! The window is full. No response possible!', 'error');
            } else if (totalSize >= 80) showStatus('Careful! The window is almost full (' + Math.round(totalSize) + '%)', 'warning');
            else hideStatus();
        }

        function setupBlockDrag(blockElement, blockData) {
            blockElement.addEventListener('dragstart', (e) => { draggedBlock = blockData; blockElement.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; });
            blockElement.addEventListener('dragend', () => { blockElement.classList.remove('dragging'); draggedBlock = null; document.querySelectorAll('.block.drag-over').forEach(el => el.classList.remove('drag-over')); });
            blockElement.addEventListener('dragover', (e) => { e.preventDefault(); if (draggedBlock && draggedBlock.id !== blockData.id) blockElement.classList.add('drag-over'); });
            blockElement.addEventListener('dragleave', () => blockElement.classList.remove('drag-over'));
            blockElement.addEventListener('drop', (e) => {
                e.preventDefault(); blockElement.classList.remove('drag-over');
                if (!draggedBlock || draggedBlock.id === blockData.id) return;
                const fromIndex = blocks.findIndex(b => b.id === draggedBlock.id);
                const toIndex = blocks.findIndex(b => b.id === blockData.id);
                if (fromIndex > -1 && toIndex > -1) {
                    const [removed] = blocks.splice(fromIndex, 1); blocks.splice(toIndex, 0, removed);
                    const blocksArea = document.getElementById('blocksArea');
                    blocks.forEach(b => blocksArea.appendChild(b.element));
                    updateBlockOrders(); updateVisuals();
                }
            });
        }

        document.querySelectorAll('.add-btn[draggable="true"]').forEach(btn => {
            btn.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', btn.dataset.type); e.dataTransfer.effectAllowed = 'copy'; });
        });
        document.getElementById('blocksArea').addEventListener('dragover', (e) => { e.preventDefault(); document.getElementById('blocksArea').classList.add('drag-over'); });
        document.getElementById('blocksArea').addEventListener('dragleave', () => document.getElementById('blocksArea').classList.remove('drag-over'));
        document.getElementById('blocksArea').addEventListener('drop', (e) => {
            e.preventDefault(); document.getElementById('blocksArea').classList.remove('drag-over');
            const type = e.dataTransfer.getData('text/plain');
            if (type && blockTypes[type] && !draggedBlock) addBlock(type);
        });

        function showStatus(message, type) { const status = document.getElementById('statusMessage'); status.textContent = message; status.className = `status-message ${type} visible`; }
        function hideStatus() { document.getElementById('statusMessage').classList.remove('visible'); }

        function resetDemo() {
            blocks = []; blockCounter = 0; storedDocuments = []; docCounter = 0;
            document.getElementById('blocksArea').innerHTML = '<div class="empty-hint" id="emptyHint">Click the buttons on the side to simulate a conversation</div>';
            document.getElementById('storageArea').innerHTML = '<div class="storage-hint" id="storageHint">In RAG mode, attachments stay here and only chunks enter the context</div>';
            document.getElementById('fillBar').style.width = '0%';
            document.getElementById('fillBar').classList.remove('warning', 'danger', 'critical');
            document.getElementById('fillText').textContent = '0%';
            document.getElementById('costValue').textContent = '$0.00';
            hideStatus();
        }

        if (window.self !== window.top) document.body.classList.add('embed-mode');
    </script>
</body>
</html>
